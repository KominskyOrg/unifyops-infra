# API Gateway Deployment Values for User API
# Uses the simplified appType-driven approach
# Usage: helm install user-api uo-infra-helm/ -f values-dev.yaml

# Global configuration
global:
  namespace: "uo-dev"
  imageRegistry: "harbor.unifyops.io/library"
  imagePullSecrets:
    - name: harbor-registry
# Stack configuration - Drives everything
stack:
  name: user
  appType: api
# Main deployment configuration
enabled: true
replicaCount: 1
# Image configuration
image:
  repository: "user-api"
  tag: "bb855e48fcdcd1dc205efc91fcb0b536834c88b8" # Updated by CI/CD workflow
  pullPolicy: Always # Use Always for latest tag in dev
# Service configuration
service:
  type: ClusterIP
  port: 8002 # api port
  targetPort: 8002
  annotations: {}
# Configuration for API Gateway
config:
  # Common config
  apiPort: "8002"
  environment: "development"
  # API-specific config
  serviceUrl: "http://user-service:8001" # Backend service URL
  authApiUrl: "http://auth-api:8002" # Auth API for token validation
  # Additional API Gateway config
  rateLimitPerMinute: "100"
  corsAllowedOrigins: "*"
# Resources for API Gateway
resources:
  requests:
    cpu: 200m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi
# Health checks
probes:
  readiness:
    enabled: true
    httpGet:
      path: "/api/user/health"
      port: 8002
    initialDelaySeconds: 10
    periodSeconds: 10
  liveness:
    enabled: true
    httpGet:
      path: "/api/user/health"
      port: 8002
    initialDelaySeconds: 30
    periodSeconds: 20
# Autoscaling - Often enabled for API Gateways
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
# Additional environment variables
env:
  - name: LOG_LEVEL
    value: "INFO"
  - name: ENABLE_METRICS
    value: "true"
  - name: USER_SERVICE_URL
    value: "http://user-service:8001"
  - name: USER_SERVICE_PREFIX
    value: "/service/user"
  - name: AUTH_API_URL
    value: "http://auth-api:8002"
  - name: AUTH_API_PREFIX
    value: "/api/auth"
# Placement
nodeSelector: {}
tolerations: []
affinity: {}
# Ingress - Automatically enabled for API appType
ingress:
  enabled: true
  className: "nginx-private"
  annotations:
    # Enable CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-max-age: "1728000"
  hosts:
    - host: dev.unifyops.io
      paths:
        - path: /api/user
          pathType: Prefix
  tls: []
# Secrets - Needed for API Gateway (JWT, etc)
# Use existing sealed secret instead of inline values
secrets:
  jwtSecret: "" # Do not inline secrets - use existingSecret instead
  existingSecret: "user-jwt-secret" # Reference sealed secret
  existingSecretJwtKey: "jwt-secret"
# Network policies
networkPolicy:
  enabled: true
  ingressNamespace: nginx-private # Use nginx-private namespace for ingress controller
  defaultDeny:
    ingress: true # API needs to accept external traffic
    egress: true
# ServiceAccount
serviceAccount:
  create: true
  annotations: {}
  name: ""
# Pod Security contexts
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
# Note: PostgreSQL subchart is NOT included for API Gateway
# API Gateways don't need databases
postgresql:
  enabled: false
database:
  waitForReady: false
  readinessTimeout: 0

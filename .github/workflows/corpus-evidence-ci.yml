name: corpus-evidence-ci

on:
  pull_request:
  push:
    branches:
      - dev
    tags:
      - 'v*'

jobs:
  corpus-evidence:
    runs-on: ubuntu-latest
    env:
      CORPUS_ROOT: evidence/validator/testdata/evidence-corpus
      CORPUS_OUTPUT_DIR: evidence/validator/test-output
      CORPUS_MATRIX: evidence/validator/test-output/corpus-matrix-report-v1.json
      CORPUS_SUMMARY: evidence/validator/test-output/corpus-summary.md
      CORPUS_REPORTS_DIR: evidence/validator/test-output/corpus-reports
      # Release-controlled lanes: tag pipelines by default.
      RELEASE_CONTROLLED_LANE: ${{ startsWith(github.ref, 'refs/tags/') && 'true' || 'false' }}
      # Temporary rollout toggle (disabled by default).
      EVIDENCE_CORPUS_NON_BLOCKING: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING || 'false' }}
      EVIDENCE_CORPUS_NON_BLOCKING_OWNER: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING_OWNER || '' }}
      EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY || '' }}
      EXPECTED_CORPUS_CASE_COUNT: ${{ vars.EXPECTED_CORPUS_CASE_COUNT || '' }}
      CORPUS_MANIFEST_PATH: ${{ vars.CORPUS_MANIFEST_PATH || '' }}
      EXPECTED_CORPUS_MANIFEST_SHA256: ${{ vars.EXPECTED_CORPUS_MANIFEST_SHA256 || '' }}
      UO_EVIDENCE_CORPUS_RUNNER_VERSION: "1.0.0"

    steps:
      - uses: actions/checkout@v4

      - name: Ensure corpus output directories exist
        run: mkdir -p "${CORPUS_OUTPUT_DIR}" "${CORPUS_REPORTS_DIR}"

      - name: Run evidence corpus runner (pinned)
        id: corpus_runner
        run: |
          set -euo pipefail
          uo-evidence-corpus-runner \
            --runner-version "${UO_EVIDENCE_CORPUS_RUNNER_VERSION}" \
            --corpus-root "${CORPUS_ROOT}" \
            --matrix-out "${CORPUS_MATRIX}" \
            --reports-dir "${CORPUS_REPORTS_DIR}" \
            --summary-md-out "${CORPUS_SUMMARY}"

      - name: Emit corpus matrix SHA-256
        id: matrix_digest
        if: always()
        run: |
          set -euo pipefail
          digest="$(sha256sum "${CORPUS_MATRIX}" | awk '{print $1}')"
          echo "corpus_matrix_sha256=${digest}" >> "$GITHUB_OUTPUT"
          echo "corpus_matrix_sha256=${digest}"

      - name: Extract required lineage outputs
        id: lineage
        if: always()
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          from pathlib import Path

          matrix = Path("evidence/validator/test-output/corpus-matrix-report-v1.json")
          data = json.loads(matrix.read_text(encoding="utf-8"))
          lineage = data.get("lineage", {})

          import os
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              for key in (
                  "source_commit_sha",
                  "release_artifact_id",
                  "release_artifact_checksum",
                  "runner_version",
                  "runner_checksum",
              ):
                  value = str(lineage.get(key, "")).strip()
                  out.write(f"{key}={value}\\n")
          PY

      - name: Validate corpus matrix policy gate
        if: always()
        run: |
          set -euo pipefail
          args=(
            --matrix "${CORPUS_MATRIX}"
            --release-controlled "${RELEASE_CONTROLLED_LANE}"
            --non-blocking "${EVIDENCE_CORPUS_NON_BLOCKING}"
            --non-blocking-owner "${EVIDENCE_CORPUS_NON_BLOCKING_OWNER}"
            --non-blocking-expiry "${EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY}"
          )

          if [[ -n "${EXPECTED_CORPUS_CASE_COUNT}" ]]; then
            args+=(--expected-case-count "${EXPECTED_CORPUS_CASE_COUNT}")
          fi

          if [[ -n "${CORPUS_MANIFEST_PATH}" || -n "${EXPECTED_CORPUS_MANIFEST_SHA256}" ]]; then
            args+=(--manifest-path "${CORPUS_MANIFEST_PATH}" --expected-manifest-sha256 "${EXPECTED_CORPUS_MANIFEST_SHA256}")
          fi

          python3 .ci/scripts/validate_corpus_matrix.py "${args[@]}"

      - name: Upload corpus matrix artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-matrix-report-v1
          path: ${{ env.CORPUS_MATRIX }}

      - name: Upload corpus summary artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-summary-md
          path: ${{ env.CORPUS_SUMMARY }}

      - name: Upload per-case corpus reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-case-reports
          path: ${{ env.CORPUS_REPORTS_DIR }}/**

      - name: Upload runner lockfile evidence (if present)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-runner-lockfiles
          if-no-files-found: warn
          path: |
            poetry.lock
            requirements*.txt

      - name: Build unified evidence envelope inputs (release-controlled)
        if: always() && env.RELEASE_CONTROLLED_LANE == 'true'
        run: |
          set -euo pipefail
          mkdir -p evidence/envelope-inputs
          cp "${CORPUS_MATRIX}" evidence/envelope-inputs/
          cp "${CORPUS_SUMMARY}" evidence/envelope-inputs/
          cp -R "${CORPUS_REPORTS_DIR}" evidence/envelope-inputs/
          tar -czf evidence/unified-evidence-envelope-inputs.tgz -C evidence envelope-inputs

      - name: Upload unified evidence envelope inputs (release-controlled)
        uses: actions/upload-artifact@v4
        if: always() && env.RELEASE_CONTROLLED_LANE == 'true'
        with:
          name: unified-evidence-envelope-inputs
          path: evidence/unified-evidence-envelope-inputs.tgz

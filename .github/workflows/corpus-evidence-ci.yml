name: corpus-evidence-ci

on:
  pull_request:
  push:
    branches:
      - dev
    tags:
      - 'v*'

jobs:
  corpus-evidence:
    runs-on: ubuntu-latest
    env:
      CORPUS_ROOT: evidence/validator/testdata/evidence-corpus
      CORPUS_OUTPUT_DIR: evidence/validator/test-output
      CORPUS_MATRIX: evidence/validator/test-output/corpus-matrix-report-v1.json
      CORPUS_SUMMARY: evidence/validator/test-output/corpus-summary.md
      CORPUS_REPORTS_DIR: evidence/validator/test-output/corpus-reports
      # Release-controlled lanes: tag pipelines by default.
      RELEASE_CONTROLLED_LANE: ${{ startsWith(github.ref, 'refs/tags/') && 'true' || 'false' }}
      # Temporary rollout toggle (disabled by default).
      EVIDENCE_CORPUS_NON_BLOCKING: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING || 'false' }}
      EVIDENCE_CORPUS_NON_BLOCKING_OWNER: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING_OWNER || '' }}
      EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY: ${{ vars.EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY || '' }}
      EXPECTED_CORPUS_CASE_COUNT: ${{ vars.EXPECTED_CORPUS_CASE_COUNT || '' }}
      CORPUS_MANIFEST_PATH: ${{ vars.CORPUS_MANIFEST_PATH || '' }}
      EXPECTED_CORPUS_MANIFEST_SHA256: ${{ vars.EXPECTED_CORPUS_MANIFEST_SHA256 || '' }}
      UO_EVIDENCE_CORPUS_RUNNER_VERSION: "1.0.0"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python for corpus runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install evidence corpus runner dependency (pinned)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install "unifyops-core==${UO_EVIDENCE_CORPUS_RUNNER_VERSION}"

      - name: Ensure corpus output directories exist
        run: mkdir -p "${CORPUS_OUTPUT_DIR}" "${CORPUS_REPORTS_DIR}"

      - name: Run evidence corpus runner (pinned)
        id: corpus_runner
        continue-on-error: true
        run: |
          set -euo pipefail
          python -m unifyops_core.evidence.validator.tools.corpus_runner \
            --runner-version "${UO_EVIDENCE_CORPUS_RUNNER_VERSION}" \
            --corpus-root "${CORPUS_ROOT}" \
            --matrix-out "${CORPUS_MATRIX}" \
            --reports-dir "${CORPUS_REPORTS_DIR}" \
            --summary-md-out "${CORPUS_SUMMARY}"

      - name: Enforce runner/matrix gate semantics
        if: always()
        run: |
          set -euo pipefail
          non_blocking="${EVIDENCE_CORPUS_NON_BLOCKING,,}"
          runner_outcome="${{ steps.corpus_runner.outcome }}"

          if [[ "${runner_outcome}" != "success" ]]; then
            if [[ "${non_blocking}" == "true" ]]; then
              echo "::warning::[NON-BLOCKING EVIDENCE CORPUS] corpus runner failed (outcome=${runner_outcome}); downstream validation is skipped."
            else
              echo "::error::Evidence corpus gate failed: corpus runner execution failed (outcome=${runner_outcome})."
              exit 1
            fi
          fi

          if [[ ! -s "${CORPUS_MATRIX}" ]]; then
            if [[ "${non_blocking}" == "true" ]]; then
              echo "::warning::[NON-BLOCKING EVIDENCE CORPUS] matrix artifact missing at ${CORPUS_MATRIX}; digest/lineage/policy validation is skipped."
            else
              echo "::error::Evidence corpus gate failed: required matrix artifact missing at ${CORPUS_MATRIX}."
              exit 1
            fi
          fi

      - name: Emit corpus matrix SHA-256
        id: matrix_digest
        if: always() && hashFiles('evidence/validator/test-output/corpus-matrix-report-v1.json') != ''
        run: |
          set -euo pipefail
          digest="$(sha256sum "${CORPUS_MATRIX}" | awk '{print $1}')"
          echo "corpus_matrix_sha256=${digest}" >> "$GITHUB_OUTPUT"
          echo "corpus_matrix_sha256=${digest}"

      - name: Extract required lineage outputs
        id: lineage
        if: always() && hashFiles('evidence/validator/test-output/corpus-matrix-report-v1.json') != ''
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          from pathlib import Path

          matrix = Path("evidence/validator/test-output/corpus-matrix-report-v1.json")
          data = json.loads(matrix.read_text(encoding="utf-8"))
          lineage = data.get("lineage", {})

          import os
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              for key in (
                  "source_commit_sha",
                  "release_artifact_id",
                  "release_artifact_checksum",
                  "runner_version",
                  "runner_checksum",
              ):
                  value = str(lineage.get(key, "")).strip()
                  out.write(f"{key}={value}\\n")
          PY

      - name: Emit runner lineage audit fields
        if: always() && hashFiles('evidence/validator/test-output/corpus-matrix-report-v1.json') != ''
        run: |
          set -euo pipefail
          echo "runner_version=${{ steps.lineage.outputs.runner_version }}"
          echo "runner_checksum=${{ steps.lineage.outputs.runner_checksum }}"
          echo "corpus_matrix_sha256=${{ steps.matrix_digest.outputs.corpus_matrix_sha256 }}"

      - name: Emit lockfile SHA-256 (if present)
        id: lockfile_digest
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          lockfiles=(poetry.lock requirements*.txt)
          if (( ${#lockfiles[@]} == 0 )); then
            echo "No lockfile evidence present"
            exit 0
          fi
          IFS=$'\n' lockfiles=($(printf '%s\n' "${lockfiles[@]}" | sort -u))
          unset IFS
          primary="${lockfiles[0]}"
          primary_sha="$(sha256sum "${primary}" | awk '{print $1}')"
          echo "lockfile_path=${primary}" >> "$GITHUB_OUTPUT"
          echo "lockfile_sha256=${primary_sha}" >> "$GITHUB_OUTPUT"
          echo "lockfile_path=${primary}"
          echo "lockfile_sha256=${primary_sha}"
          for lf in "${lockfiles[@]}"; do
            sha="$(sha256sum "${lf}" | awk '{print $1}')"
            echo "lockfile_sha256[${lf}]=${sha}"
          done

      - name: Build corpus artifacts integrity metadata
        if: always()
        run: |
          set -euo pipefail
          mkdir -p "${CORPUS_OUTPUT_DIR}"
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          out = Path(os.environ['CORPUS_OUTPUT_DIR']) / 'corpus-artifacts-metadata.json'
          data = {
              'corpus_matrix_path': os.environ.get('CORPUS_MATRIX', ''),
              'corpus_matrix_sha256': '${{ steps.matrix_digest.outputs.corpus_matrix_sha256 }}',
              'runner_version': '${{ steps.lineage.outputs.runner_version }}',
              'runner_checksum': '${{ steps.lineage.outputs.runner_checksum }}',
              'lockfile_path': '${{ steps.lockfile_digest.outputs.lockfile_path }}',
              'lockfile_sha256': '${{ steps.lockfile_digest.outputs.lockfile_sha256 }}',
          }
          out.write_text(json.dumps(data, indent=2, sort_keys=True) + '\n', encoding='utf-8')
          print(f'wrote metadata: {out}')
          PY

      - name: Validate corpus matrix policy gate
        if: always() && hashFiles('evidence/validator/test-output/corpus-matrix-report-v1.json') != ''
        run: |
          set -euo pipefail
          args=(
            --matrix "${CORPUS_MATRIX}"
            --release-controlled "${RELEASE_CONTROLLED_LANE}"
            --non-blocking "${EVIDENCE_CORPUS_NON_BLOCKING}"
            --non-blocking-owner "${EVIDENCE_CORPUS_NON_BLOCKING_OWNER}"
            --non-blocking-expiry "${EVIDENCE_CORPUS_NON_BLOCKING_EXPIRY}"
          )

          if [[ -n "${EXPECTED_CORPUS_CASE_COUNT}" ]]; then
            args+=(--expected-case-count "${EXPECTED_CORPUS_CASE_COUNT}")
          fi

          if [[ -n "${CORPUS_MANIFEST_PATH}" || -n "${EXPECTED_CORPUS_MANIFEST_SHA256}" ]]; then
            args+=(--manifest-path "${CORPUS_MANIFEST_PATH}" --expected-manifest-sha256 "${EXPECTED_CORPUS_MANIFEST_SHA256}")
          fi

          echo "validate_corpus_matrix.py invocation (blocking parser enforcement path active)"
          printf '  %q\n' python3 .ci/scripts/validate_corpus_matrix.py "${args[@]}"
          python3 .ci/scripts/validate_corpus_matrix.py "${args[@]}"

      - name: Upload corpus matrix artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-matrix-report-v1
          if-no-files-found: warn
          path: |
            ${{ env.CORPUS_MATRIX }}
            ${{ env.CORPUS_OUTPUT_DIR }}/corpus-artifacts-metadata.json

      - name: Upload corpus summary artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-summary-md
          if-no-files-found: warn
          path: ${{ env.CORPUS_SUMMARY }}

      - name: Upload per-case corpus reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-case-reports
          if-no-files-found: warn
          path: ${{ env.CORPUS_REPORTS_DIR }}/**

      - name: Upload runner lockfile evidence (if present)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: corpus-runner-lockfiles
          if-no-files-found: warn
          path: |
            poetry.lock
            requirements*.txt

      - name: Build unified evidence envelope inputs (release-controlled)
        if: always() && env.RELEASE_CONTROLLED_LANE == 'true' && hashFiles('evidence/validator/test-output/corpus-matrix-report-v1.json') != ''
        run: |
          set -euo pipefail
          mkdir -p evidence/envelope-inputs
          cp "${CORPUS_MATRIX}" evidence/envelope-inputs/
          cp "${CORPUS_SUMMARY}" evidence/envelope-inputs/
          cp -R "${CORPUS_REPORTS_DIR}" evidence/envelope-inputs/
          if [[ -f "${CORPUS_OUTPUT_DIR}/corpus-artifacts-metadata.json" ]]; then
            cp "${CORPUS_OUTPUT_DIR}/corpus-artifacts-metadata.json" evidence/envelope-inputs/integrity-metadata.json
          fi
          if [[ -n "${{ steps.lockfile_digest.outputs.lockfile_path }}" && -f "${{ steps.lockfile_digest.outputs.lockfile_path }}" ]]; then
            mkdir -p evidence/envelope-inputs/lockfiles
            cp "${{ steps.lockfile_digest.outputs.lockfile_path }}" evidence/envelope-inputs/lockfiles/
          fi
          tar -czf evidence/unified-evidence-envelope-inputs.tgz -C evidence envelope-inputs

      - name: Upload unified evidence envelope inputs (release-controlled)
        uses: actions/upload-artifact@v4
        if: always() && env.RELEASE_CONTROLLED_LANE == 'true'
        with:
          name: unified-evidence-envelope-inputs
          if-no-files-found: warn
          path: evidence/unified-evidence-envelope-inputs.tgz
